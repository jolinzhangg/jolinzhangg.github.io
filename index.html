<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="含英咀华，凤凰于飞">
<meta property="og:type" content="website">
<meta property="og:title" content="凤凰花开芙蓉畔">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="凤凰花开芙蓉畔">
<meta property="og:description" content="含英咀华，凤凰于飞">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="凤凰花开芙蓉畔">
<meta name="twitter:description" content="含英咀华，凤凰于飞">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> 凤凰花开芙蓉畔 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">凤凰花开芙蓉畔</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/31/open-falcon/counter数据的统计/" itemprop="url">
                  counter类型数据的统计
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-07-31T15:00:00+08:00" content="2017-07-31">
              2017-07-31
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/open-falcon/" itemprop="url" rel="index">
                    <span itemprop="name">open-falcon</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/07/31/open-falcon/counter数据的统计/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/31/open-falcon/counter数据的统计/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>今天在整理mysql监控项数据时，发现对于全表扫描select_scan这个指标，监控到的数据竟然有的时候是小数，如图1所示。</p>
<p><img src="./img/counter1.png" alt="图1，select_scan监控项是小数"><br>但是按理说次数应该是整数呀，并且在mysql官方文档中，也明确说明是integer类型，如图2所示。</p>
<p><img src="./img/counter2.png" alt=""><br>于是我开始怀疑这个上报指标是不是有问题，并且群里之前有人吐槽mysql的插件mymon的好多监控指标有问题，单位模糊之类。所以我开始从mymon入手，调查这个metric的值的获取是否正确。</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/07/31/open-falcon/counter数据的统计/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/25/open-falcon/redis-plugins/" itemprop="url">
                  redis-plugins
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-07-25T15:00:00+08:00" content="2017-07-25">
              2017-07-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/open-falcon/" itemprop="url" rel="index">
                    <span itemprop="name">open-falcon</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/07/25/open-falcon/redis-plugins/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/25/open-falcon/redis-plugins/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在transfer组件的配置文件中有三个监听模块，分别是：http监听6060，rpc监听8433，socket监听4444。其中http为组件提供对外的控制接口；rpc为agent提供上报服务；socket提供一种基于socket的连接方式，但不推荐使用，日后可能会被废弃。</p>
<p>经transfer组件后，由agent上报来的数据，会通过一致性hash路由到judge和graph组件。</p>
<p>通过进程内队列将收集的数据放进queue，再由send_tasks，批量pop出batch条记录进行发送。</p>
<pre><code>var (
TsdbQueue   *nlist.SafeListLimited
JudgeQueues = make(map[string]*nlist.SafeListLimited)// make用来初始化
GraphQueues = make(map[string]*nlist.SafeListLimited)// map后面的string是key type, 后面的指针是value type
</code></pre><p>)</p>
<p>judge和graph发送逻辑类似，发送过程使用简单for循环进行重试，最多重试三次。</p>
<blockquote>
<p><a href="https://github.com/ZhuoRoger/redismon" target="_blank" rel="external">https://github.com/ZhuoRoger/redismon</a></p>
<p><a href="https://github.com/iambocai/falcon-monit-scripts/tree/master/redis" target="_blank" rel="external">https://github.com/iambocai/falcon-monit-scripts/tree/master/redis</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/25/open-falcon/agent/" itemprop="url">
                  agent
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-07-25T15:00:00+08:00" content="2017-07-25">
              2017-07-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/open-falcon/" itemprop="url" rel="index">
                    <span itemprop="name">open-falcon</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/07/25/open-falcon/agent/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/25/open-falcon/agent/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="./img/agent1.png" alt=""></p>
<p>agent包含两部分上报信息：其一是上报心跳到HBS，其二是上报metrics到transfer。</p>
<p>main.go在根目录下，是程序的入口。主函数依次创建一系列协程。除了在main中显示通过go创建的外，其他均在cron包中创建。</p>
<h2 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h2><ol>
<li>初始化相关配置。</li>
<li>上报心跳到HBS组件。</li>
<li>上报metrics到Transfer组件。</li>
<li>开启http接口服务，端口是1988,对插件暴露的上报接口,收集其他插件上报来的metric,统一由agent上报给transfer。</li>
<li>通过select{}，阻塞当前main函数，来使主函数不退出，可以一直在后台运行。</li>
</ol>
<h2 id="上报心跳数据"><a href="#上报心跳数据" class="headerlink" title="上报心跳数据"></a>上报心跳数据</h2><ol>
<li>默认通过heartbeat.addr上报心跳到HBS组件，默认是6030端口。</li>
<li>使用rpc，上报主机存活信息cron.ReportAgentStatus()。</li>
<li>同步进程端口，cron.SyncBuiltinMetrics()</li>
<li>同步监控插件，cron.SyncMinePlugins()</li>
<li>同步信任ip，cron.SyncTrustableIps()</li>
</ol>
<h2 id="上报metrics"><a href="#上报metrics" class="headerlink" title="上报metrics"></a>上报metrics</h2><ol>
<li><p>funcs.BuildMappers()函数，创建Mappers，包含四个FuncsAndInterval机器负载信息、硬件信息、服务器监控信息、开源软件监控指标。即Mappers中已经规定包含四个FuncsAndInterval，每个FuncsAndInterval中有一个Fs，Fs是一个model.MetricValue结构体数组指针，四个Fs内容如下：</p>
<p> a、AgentMetrics，CpuMetrics，NetMetrics，KernelMetrics，LoadAvgMetrics，MemMetrics，DiskIOMetrics，IOStatsMetrics，NetstatMetrics，ProcMetrics，UdpMetrics</p>
<p> b、DeviceMetrics</p>
<p> c、PortMetrics，SocketStatSummaryMetrics</p>
<p> d、DuMetrics</p>
</li>
<li><p>Metrics主要有两种类型，GAUGE和COUNTER，前者为瞬时指标，后者为累加数据。</p>
</li>
<li>通过cron.collect()函数定时收集上述metrics，再通过g.SendToTransfer（）函数上报给transfer组件。默认通过配置文件中的transfer.addrs获取组件ip和端口，默认8843端口。</li>
<li>使用简单的随机策略,随机获取一组transfer中的一个.因此agent可以保证transfer集群的HA。上报成功,break;否则继续随机下一个transfer上报</li>
</ol>
<blockquote>
<p><a href="https://github.com/open-falcon" target="_blank" rel="external">https://github.com/open-falcon</a></p>
<p><a href="https://book.open-falcon.org/zh_0_2/" target="_blank" rel="external">https://book.open-falcon.org/zh_0_2/</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/24/golang/tutorial/" itemprop="url">
                  Golang学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-07-24T15:00:00+08:00" content="2017-07-24">
              2017-07-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Golang/" itemprop="url" rel="index">
                    <span itemprop="name">Golang</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/07/24/golang/tutorial/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/24/golang/tutorial/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>#包<br>每个 Go 程序都是由包组成的。</p>
<p>程序运行的入口是包 main 。</p>
<p>这个程序使用并导入了包 “fmt” 和 “math/rand” 。</p>
<p>按照惯例，包名与导入路径的最后一个目录一致。例如，”math/rand” 包由 package rand 语句开始。</p>
<p>#并发</p>
<p>##goroutine</p>
<p>goroutine 是由 Go 运行时环境管理的轻量级线程。</p>
<p>go f(x, y, z)<br>开启一个新的 goroutine 执行</p>
<p>f(x, y, z)<br>f，x，y 和 z 是当前 goroutine 中定义的，但是在新的 goroutine 中运行 f。</p>
<p>goroutine 在相同的地址空间中运行，因此访问共享内存必须进行同步。</p>
<pre><code>package main

import (
    &quot;fmt&quot;
    &quot;time&quot;
)

func say(s string) {
    for i := 0; i &lt; 5; i++ {
        time.Sleep(100 * time.Millisecond)
        fmt.Println(s)
    }
}

func main() {
    go say(&quot;world&quot;)
    say(&quot;hello&quot;)
}
</code></pre>
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/07/24/golang/tutorial/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/05/redis/getDeeper/" itemprop="url">
                  redis进阶
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-04-05T01:06:00+08:00" content="2017-04-05">
              2017-04-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/04/05/redis/getDeeper/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/05/redis/getDeeper/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><pre><code>multi
...
exec

watch
</code></pre><h2 id="过期时间"><a href="#过期时间" class="headerlink" title="过期时间"></a>过期时间</h2><p>在关系型数据库中一般需要一个额外的字段记录到期时间，然后定期检查，删除过期数据。在redis中可以使用expire命令设置一个键的过期时间，到时间后redis会自动删除它。</p>
<pre><code>set key value
expire key time 设置过期时间，返回1表示成功；0表示键不存在或设置失败
ttl key    返回键的剩余时间，单位是秒。当键不存在时，返回-2。-1表示永久键。
persist key 取消过期时间，将键改为永久键。使用set和getset赋值的同时也可以清楚过期时间。

对应的还有另外一组设置毫秒时间的
pexpire
pttl
</code></pre><p>过期时间实现访问频率限制</p>
<ol>
<li>利用过期时间，每分钟设置一个key，incr到指定数量时，拒绝。过期后重新计数。</li>
<li>用列表存储，每个新请求，判断列表是否到达最大长度，若未到达，直接加入；否则，与最早的时间比较，看时间间隔是否大于1分钟，若大于，将最早的时间删除，新时间插入；否则拒绝。</li>
</ol>
<p>过期时间实现缓存。限制redis占用的最大内存，不设置过期时间，而让redis通过一定的规则淘汰不需要的缓存键。修改maxmemory参数，设置maxmemory-policy。eg. allkeys-lru</p>
<h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><pre><code>127.0.0.1:6379&gt; sadd posts 2 6 12 26
(integer) 4
127.0.0.1:6379&gt; smember posts
(error) ERR unknown command &apos;smember&apos;
127.0.0.1:6379&gt; smembers posts
1) &quot;2&quot;
2) &quot;6&quot;
3) &quot;12&quot;
4) &quot;26&quot;
127.0.0.1:6379&gt; hset post:2 time 1352619200
(integer) 1
127.0.0.1:6379&gt; hset post:6 time 1352619600
(integer) 1
127.0.0.1:6379&gt; hset post:12 time 1352610100
(integer) 1
127.0.0.1:6379&gt; hset post:26 time 1352612000
(integer) 1
127.0.0.1:6379&gt; sort posts
1) &quot;2&quot;
2) &quot;6&quot;
3) &quot;12&quot;
4) &quot;26&quot;
## 这里by的感觉很像是表连接
127.0.0.1:6379&gt; sort posts by post:*-&gt;time desc
1) &quot;6&quot;
2) &quot;2&quot;
3) &quot;26&quot;
4) &quot;12&quot;
</code></pre><p>通过sort命令的get参数，该参数不影响排序，作用是似的sort命令的返回结果不再是元素自身的值，而是get参数中指定的键值。</p>
<pre><code>127.0.0.1:6379&gt; sort posts by post:*-&gt;time desc get post:*-&gt;title
1) &quot;66666&quot;
2) &quot;windows 8&quot;
3) &quot;262626&quot;
4) &quot;121212&quot;
## 一个sort也可以带有多个get参数（但by只能有一个）
sort posts by post:*-&gt;time desc get post:*-&gt;title get post:*-&gt;time get #
1) &quot;66666&quot;
2) &quot;1352619600&quot;
3) &quot;windows 8&quot;
4) &quot;1352619200&quot;
5) &quot;262626&quot;
6) &quot;1352612000&quot;
7) &quot;121212&quot;
8) &quot;1352610100&quot;

get # 会返回元素本身。
</code></pre><p>store参数保存排序结果</p>
<pre><code>sort posts by post:*-&gt;time desc get post:*-&gt;title get post:*-&gt;time get # store sort.result  
(integer) 12   ## 保存的键类型是列表类型，返回值为结果个数
127.0.0.1:6379&gt; lrange sort.result 0 -1
 1) &quot;66666&quot;
 2) &quot;1352619600&quot;
 3) &quot;6&quot;
 4) &quot;windows 8&quot;
 5) &quot;1352619200&quot;
 6) &quot;2&quot;
 7) &quot;262626&quot;
 8) &quot;1352612000&quot;
 9) &quot;26&quot;
10) &quot;121212&quot;
11) &quot;1352610100&quot;
12) &quot;12&quot;
</code></pre><p>sort对性能的影响<br>O(n+mlog(m))，n为待排序列表中元素个数，m为排序结果返回的个数。</p>
<ol>
<li>尽量减少待排序键中元素的数量（减少n）</li>
<li>使用limit只获取需要的数据（减少m）</li>
<li>尽量使用store参数缓存</li>
</ol>
<h2 id="消息通知"><a href="#消息通知" class="headerlink" title="消息通知"></a>消息通知</h2><p>订阅功能，将用户邮箱存储在集合中，当新增文章后，就向集合中的邮箱地址发送通知邮件。</p>
<p>当页面需要进行如发送邮件、复杂数据运算等耗时较长的操作时会阻塞页面的渲染，为了避免用户等待太久，应该使用独立的线程来完成。</p>
<p>松耦合，生产者和消费者无需知道彼此的实现细节。易于扩展，消费者可以有多个，分布在不同机器中，轻松降低单台服务器的负载。</p>
<p>结合lpush和rpop，往列表左侧添加，右侧取出，模拟消息队列。同时redis提供brpop命令，当没有元素可以取出时，brpop命令将会阻塞，直到油新元素加入。</p>
<pre><code>brpop key timeout
其中time为超时时间，0表示不限制等待时间，即将一直等待下去。

brpop key [key ...] timeout 可以实现优先队列，当多个key对应的列表都有数据可以取出的时候，按从左到右的列表顺序
</code></pre><h2 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h2><p>当一组命令中每条命令都不依赖于之前命令的执行结果时就可以将这组命令一起通过管道发出，从简降低往返时延累计值。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/05/redis/begin/" itemprop="url">
                  redis入门
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-04-05T01:06:00+08:00" content="2017-04-05">
              2017-04-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/04/05/redis/begin/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/05/redis/begin/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="几个基础命令"><a href="#几个基础命令" class="headerlink" title="几个基础命令"></a>几个基础命令</h2><pre><code>keys *
exists key
del key 由于del不支持通配符，所以可以结合管道和xargs，redis-cli keys &quot;user:*&quot; | xargs redis-cli del
type key 获取键值的数据类型
</code></pre><h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><pre><code>set key value 赋值
get key 取值
incr key 递增数字

incrby key increment 增加指定整数
decr key
decrby key decrement
incrbyfloat key increment

append key value 向尾部追加
strlen key 获取字符串长度
mget key [key ...] 同时获取多个键值
mset key value [key value ...] 同时设置多个键值
</code></pre><p>最好使用“对象类型：对象ID：对象属性”来命名一个键，eg，user:1:friends</p>
<ul>
<li>文章访问量统计</li>
<li>生成自增ID（作用同关系型数据库的auto_increment）</li>
<li>存储文章数据</li>
</ul>
<h2 id="散列"><a href="#散列" class="headerlink" title="散列"></a>散列</h2><pre><code>hset
hget
hmset
hmget
hgetall
hexists
hsetnx key field value 如果字段存在命令不执行任何操作
hincrby key field increment
hdel key field [field ...]
hkeys key 获取key对应的所有字段
hvals key 获取key对应的所有字段对应的值
hlen key 获取字段数量
</code></pre><ul>
<li>存储文章数据</li>
<li>存储文章缩略名</li>
</ul>
<h2 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h2><p>list可以向两端添加元素，或者获得列表的某一片段</p>
<pre><code>lpush key value [value ...]
rpush key value [value ...]
lpop key
rpop key
llen key
lrange key start stop
lrem key count value
lindex key index
lset key index value
ltrim key start end
linsert key before|after pivot value
rpoplpush source destination
</code></pre><ul>
<li>存储文章ID列表</li>
<li>存储品论列表</li>
</ul>
<h2 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h2><pre><code>sadd key number [number ...]
srem key number [number ...]
smembers key
sismember key member
sdiff key [key ...]
sinter key [key ...]
sunion key [key ...]
</code></pre><ul>
<li>存储文章标签</li>
<li>通过标签搜索文章</li>
</ul>
<h2 id="有序集合"><a href="#有序集合" class="headerlink" title="有序集合"></a>有序集合</h2><pre><code>zadd key score member [member ...]
zscore key member
zrange key star stop [withscores] 按分数从小到大
zrevrange key start stop [withscores] 
zrangebyscore key min max [withscores] [limit offset count]
zincrby key increment member
zcard key 获取集合中元素的数量
zcount key min max
zrem key member [member ...]
zremrangebyrank key start stop 按排名范围删除元素
zremrangebyscore key min max 按照分数范围删除元素
zrank key member 获取元素排名
zrevrank key member 
</code></pre><ul>
<li>实现按点击量排序</li>
<li>改进按时间排序</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/05/elk/elk-start/" itemprop="url">
                  LogStash入门
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-04-05T01:06:00+08:00" content="2017-04-05">
              2017-04-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/LogStash/" itemprop="url" rel="index">
                    <span itemprop="name">LogStash</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/04/05/elk/elk-start/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/05/elk/elk-start/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Logstash is a tool for managing events and logs. You can use it to collect logs, parse them, and store them for later use (like, for searching).</p>
</blockquote>
<p>什么是 Logstash？为什么要用 Logstash？怎么用 Logstash？</p>
<p>安装</p>
<ol>
<li><p>使用软件仓库的配置</p>
<p> rpm –import <a href="http://packages.elasticsearch.org/GPG-KEY-elasticsearch" target="_blank" rel="external">http://packages.elasticsearch.org/GPG-KEY-elasticsearch</a><br> cat &gt; /etc/yum.repos.d/logstash.repo &lt;&lt;EOF<br> [logstash-5.0]<br> name=logstash repository for 5.0.x packages<br> baseurl=<a href="http://packages.elasticsearch.org/logstash/5.0/centos" target="_blank" rel="external">http://packages.elasticsearch.org/logstash/5.0/centos</a><br> gpgcheck=1<br> gpgkey=<a href="http://packages.elasticsearch.org/GPG-KEY-elasticsearch" target="_blank" rel="external">http://packages.elasticsearch.org/GPG-KEY-elasticsearch</a><br> enabled=1<br> EOF<br> yum clean all<br> yum install logstash</p>
</li>
<li><p>可以访问 <a href="https://www.elastic.co/downloads/logstash" target="_blank" rel="external">https://www.elastic.co/downloads/logstash</a> 页面找对应操作系统和版本</p>
</li>
</ol>
<p>运行</p>
<pre><code>bin/logstash -e &apos;input{stdin{}}output{stdout{codec=&gt;rubydebug}}&apos;
</code></pre><p>结果</p>
<pre><code>{
    &quot;message&quot; =&gt; &quot;Hello World&quot;,
     &quot;@version&quot; =&gt; &quot;1&quot;,
    &quot;@timestamp&quot; =&gt; &quot;2014-08-07T10:30:59.937Z&quot;,
    &quot;host&quot; =&gt; &quot;raochenlindeMacBook-Air.local&quot;,
}
</code></pre><p><img src="https://www.elastic.co/guide/en/logstash/current/static/images/basic_logstash_pipeline.png" alt=""></p>
<p>plugin</p>
<pre><code>Usage:
        bin/plugin [OPTIONS] SUBCOMMAND [ARG] ...

Parameters:
    SUBCOMMAND                    subcommand
    [ARG] ...                     subcommand arguments

Subcommands:
    install                       Install a plugin
    uninstall                     Uninstall a plugin
    update                        Install a plugin
    list                          List all installed plugins

Options:
    -h, --help                    print help
</code></pre><p>Filebeat client可以在服务端收集log文件，并传送到logstash实例。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/05/redis/persistence/" itemprop="url">
                  持久化
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-04-05T01:06:00+08:00" content="2017-04-05">
              2017-04-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/04/05/redis/persistence/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/05/redis/persistence/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h2><p>通过快照（snapshotting）完成，当出现以下几种情况时，进行快照：</p>
<ol>
<li>根据配置自动进行，在redis.conf中save部分</li>
<li>用户执行save（同步快照，会阻塞所有客户端请求）或bgsave（异步快照）</li>
<li>执行flushall（前提是必须定义自动快照条件，否则即使执行，也不会进行快照）</li>
<li>执行复制（replication），主从模式，在复制初始化时进行。</li>
</ol>
<h3 id="快照原理"><a href="#快照原理" class="headerlink" title="快照原理"></a>快照原理</h3><p>默认快照文件存储在redis当前进程的工作目录中的dump.rdb文件中，通过redis-cli启动客户端时，文件在redis-cli所在的文件夹中。<br>使用fork函数赋值一份当前进程（父进程）的副本（子进程）。父进程继续接受并处理客户端的请求，而子进程开始将内存中的数据写入硬盘中的临时文件。写入所有数据后会用改临时文件替换旧的RDB文件，至此完成一次快照操作。</p>
<p>fork的时候，会使用写时赋值策略（copy-on-write），开始时共享内存，当父进程需要更改数据时，操作系统会将该数据复制一份保证子进程的数据不受影响，所以RDB文件存储的是执行fork时刻的内存数据。</p>
<h2 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h2><p>append only file，默认情况下不开启，可通过appendonly yes参数启用。每执行一条会更改redis数据的命令，redis就会将该命令写入磁盘中的aof文件。aof文件的位置和rdb文件的位置相同。</p>
<p>以纯文本形式记录了redis执行的写命令。每当达到一定条件时redis就会自动重写aof文件，去除文件中冗余的数据。</p>
<h3 id="同步硬盘数据"><a href="#同步硬盘数据" class="headerlink" title="同步硬盘数据"></a>同步硬盘数据</h3><p>由于操作系统缓存机制，数据并没有真正地写入硬盘，而是进入系统的硬盘缓存。默认情况下每30s执行一次同步操作，将缓存中的内容真正写入硬盘。</p>
<pre><code>appendfsync always    每次操作都同步
appendfsync everysec    没个若干秒同步；这是兼顾性能和安全的考虑。
appendfsync no    不同步，由操作系统决定，即30s
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/05/java/java-memory/" itemprop="url">
                  Java内存区域
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-04-05T01:06:00+08:00" content="2017-04-05">
              2017-04-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JVM/" itemprop="url" rel="index">
                    <span itemprop="name">JVM</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/04/05/java/java-memory/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/05/java/java-memory/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="运行时数据区域"><a href="#运行时数据区域" class="headerlink" title="运行时数据区域"></a>运行时数据区域</h2><h3 id="程序计数器"><a href="#程序计数器" class="headerlink" title="程序计数器"></a>程序计数器</h3><p>当前线程执行字节码的行号指示器。在虚拟机的概念模型里，通过这个行号指示下一条要执行的指令，分支、循环、跳转、异常处理、线程恢复等。线程独立。当执行java方法的时候，指示的是虚拟机字节码指令的地址；执行native方法是，这个值为空。</p>
<p>唯一一个没有在虚拟机规范中规定任何OutOfMemoryError的区域。</p>
<h3 id="虚拟机栈"><a href="#虚拟机栈" class="headerlink" title="虚拟机栈"></a>虚拟机栈</h3><p>线程私有。栈帧的入栈和出栈过程。每个栈帧存储局部变量表、操作数栈、动态链接库、方法出口等信息。可以抛出StackOverflowError异常，栈本身不够用；OutOfMemoryError，扩充栈的时候没有申请到足够的空间。</p>
<h3 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h3><p>运行native方法服务。也会抛出上述两个异常。</p>
<h3 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h3><p>虚拟机管理的最大一块内存。虚拟机规范要求，所有对象实例以及数组都要在堆上分配。分代：新生代和老年代；新生代分为Eden区和两个Survivor区。规范规定，堆可以处于物理上不连续的内存空间中，只要逻辑上连续即可，就像磁盘一样。当堆中没有足够的内存分配，且堆无法扩展的时候，将会跑出OutOfMemoryError异常。</p>
<h3 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h3><p>线程共享，存储被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。HotSpot将其称为永久代，是因为GC分代收集扩展至方法区。回收目标针对常量池的回收和类型的卸载。也会跑出OutOfMemoryError异常。</p>
<h3 id="运行时常量池"><a href="#运行时常量池" class="headerlink" title="运行时常量池"></a>运行时常量池</h3><p>方法区的一部分，存放各种字面量和符号引用。String类的intern()返回这里的值。同意可能返回OutOfMemoryError异常。</p>
<h3 id="直接内存"><a href="#直接内存" class="headerlink" title="直接内存"></a>直接内存</h3><p>Direct Memory并不是虚机运行时数据区的一部分，也不是虚拟机规范定义的内存区域。堆内的DirectByteBuffer对象对堆外内存引用进行操作，避免在java堆和native堆间来回复制数据，一些场景可以提高性能。</p>
<h2 id="对象访问"><a href="#对象访问" class="headerlink" title="对象访问"></a>对象访问</h2><p>对象类型信息存储在方法区。</p>
<p>栈和堆之间的访问方式一般两种：1.使用句柄，reference中存储的是稳定的句柄地址，对象移动时只会改变句柄中的实例数据指针；2.使用之间指针，节省一次指针寻址。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/16/es/index/" itemprop="url">
                  索引
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-11-16T00:00:00+08:00" content="2016-11-16">
              2016-11-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/elasticsearch/" itemprop="url" rel="index">
                    <span itemprop="name">elasticsearch</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/11/16/es/index/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/11/16/es/index/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h2><pre><code>curl -XPUT http://localhost:9200/blog/article/1 -d &apos;{
  &quot;title&quot;: &quot;New version of es!&quot;,
  &quot;content&quot;: &quot;...&quot;,
  &quot;tags&quot;: [
    &quot;announce&quot;,
    &quot;es&quot;,
    &quot;release&quot;
  ]
}&apos;
</code></pre><p>当然也可以通过如下命令创建</p>
<pre><code>curl -XPUT http://localhost:9200/blog/
</code></pre><p>当索引存在的时候，结果会提示</p>
<pre><code>{
    &quot;error&quot;: {
        &quot;root_cause&quot;: [
            {
                &quot;type&quot;: &quot;index_already_exists_exception&quot;,
                &quot;reason&quot;: &quot;index [blog/mwdQFFt9QTydOWX2V_0d8Q] already exists&quot;,
                &quot;index_uuid&quot;: &quot;mwdQFFt9QTydOWX2V_0d8Q&quot;,
                &quot;index&quot;: &quot;blog&quot;
            }
        ],
        &quot;type&quot;: &quot;index_already_exists_exception&quot;,
        &quot;reason&quot;: &quot;index [blog/mwdQFFt9QTydOWX2V_0d8Q] already exists&quot;,
        &quot;index_uuid&quot;: &quot;mwdQFFt9QTydOWX2V_0d8Q&quot;,
        &quot;index&quot;: &quot;blog&quot;
    },
    &quot;status&quot;: 400
}
</code></pre><p>es的结果也是以json显示的，相关字段会有提示index already exists</p>
<p>在创建第一个文档的时候可能并不关心索引，如果索引blog不存在，es会默认自动创建该索引。</p>
<pre><code>action.auto_create_index: -an*, +a*, -*
可以配置是否自动创建索引，eg，对于a开头的自动创建，an开头的不创建，其他索引也必须手动创建。
</code></pre><p>在创建索引的时候，可以通过settings指定相关参数，如</p>
<pre><code>&quot;settings&quot;: {
    &quot;number_of_shards&quot;：
    &quot;number_of_replicas&quot;：
}
</code></pre><h2 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h2><pre><code>curl -XDELETE http://10.10.193.203:9200/blog2/
</code></pre><p>es对索引字段的类型存在自动检测，同时会对索引中未包含的字段自动加入到索引字段中，有时候这样是我们不想看到的。可以通过”dynamic”：”false”来关闭自动添加字段。</p>
<p>es中使用模式映射（schema mapping）定义索引结构。</p>
<h2 id="索引文档index"><a href="#索引文档index" class="headerlink" title="索引文档index"></a>索引文档index</h2><pre><code>PUT twitter/tweet/1
{
    &quot;user&quot; : &quot;kimchy&quot;,
    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,
    &quot;message&quot; : &quot;trying out Elasticsearch&quot;
}
# 修改某一版本文档
PUT twitter/tweet/1?version=1
{
    &quot;message&quot; : &quot;elasticsearch now has versioning support, double cool!&quot;
}
</code></pre><p>接受op_type参数，以下两者等价。</p>
<pre><code>PUT twitter/tweet/1?op_type=create
{
    &quot;user&quot; : &quot;kimchy&quot;,
    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,
    &quot;message&quot; : &quot;trying out Elasticsearch&quot;
}
PUT twitter/tweet/1/_create
{
    &quot;user&quot; : &quot;kimchy&quot;,
    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,
    &quot;message&quot; : &quot;trying out Elasticsearch&quot;
}
</code></pre><p>当不传入id时，默认生成id，并索引文档</p>
<pre><code>POST twitter/tweet/
{
    &quot;user&quot; : &quot;kimchy&quot;,
    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,
    &quot;message&quot; : &quot;trying out Elasticsearch&quot;
}
</code></pre><p>可以通过routing参数，设置路由，这样，可以让多个文档路由到相同的分片；依次，查询时也要设置路由参数，否则无法查询到。Note, issuing a get without the correct routing, will cause the document not to be fetched.</p>
<p>获取文档get</p>
<pre><code>GET /twitter/tweet/1
curl -XGET &quot;http://10.10.193.203:9200/twitter/tweet/1&quot;
</code></pre><p>get默认会返回文档的source字段，除非增加参数_source=false</p>
<pre><code>curl -XGET &apos;http://localhost:9200/twitter/tweet/1?_source=false&apos;
</code></pre><p>从source字段中包含或删除</p>
<pre><code>GET /twitter/tweet/2?_source_include=user&amp;_source_exclude=message
GET /twitter/tweet/2?_source_include=user,message
</code></pre><p>Stored Field</p>
<pre><code>PUT twitter
{
   &quot;mappings&quot;: {
      &quot;tweet&quot;: {
         &quot;properties&quot;: {
            &quot;counter&quot;: {
               &quot;type&quot;: &quot;integer&quot;,
               &quot;store&quot;: false    #不存储类型
            },
            &quot;tags&quot;: {
               &quot;type&quot;: &quot;keyword&quot;,
               &quot;store&quot;: true    #存储类型
            }
         }
      }
   }
}
PUT twitter/tweet/1        #索引一个文档
{
    &quot;counter&quot; : 1,
    &quot;tags&quot; : [&quot;red&quot;]
}
GET twitter/tweet/1?stored_fields=tags,counter        #查询两个存储字段
# 结果只有tags字段返回，非stored字段将被查询忽略
{
   &quot;_index&quot;: &quot;twitter&quot;,
   &quot;_type&quot;: &quot;tweet&quot;,
   &quot;_id&quot;: &quot;1&quot;,
   &quot;_version&quot;: 1,
   &quot;found&quot;: true,
   &quot;fields&quot;: {
      &quot;tags&quot;: [
         &quot;red&quot;
      ]
   }
}
</code></pre><p>通过/{index}/{type}/{id}/_source直接获取source字段</p>
<pre><code>GET /twitter/tweet/2/_source
# 也可以增加参数
GET /twitter/tweet/2/_source?_source_include=*.id&amp;_source_exclude=entities&apos;
</code></pre><h2 id="文档删除"><a href="#文档删除" class="headerlink" title="文档删除"></a>文档删除</h2><pre><code>curl -XDELETE &apos;http://localhost:9200/twitter/tweet/1&apos;
DELETE /twitter/tweet/1
</code></pre><p>同样受routing参数影响</p>
<h2 id="文档更新"><a href="#文档更新" class="headerlink" title="文档更新"></a>文档更新</h2><pre><code>PUT test/type1/1
{
    &quot;counter&quot; : 1,
    &quot;tags&quot; : [&quot;red&quot;]
}
POST test/type1/1/_update
{
    &quot;script&quot; : {
        &quot;inline&quot;: &quot;ctx._source.counter += params.count&quot;,
        &quot;lang&quot;: &quot;painless&quot;,
        &quot;params&quot; : {
            &quot;count&quot; : 4
        }
    }
}
结果
{
  &quot;_index&quot;: &quot;test&quot;,
  &quot;_type&quot;: &quot;type1&quot;,
  &quot;_id&quot;: &quot;1&quot;,
  &quot;_version&quot;: 2,
  &quot;found&quot;: true,
  &quot;_source&quot;: {
    &quot;counter&quot;: 5,
    &quot;tags&quot;: [
      &quot;red&quot;
    ]
  }
}
POST test/type1/1/_update
{
    &quot;script&quot; : {
        &quot;inline&quot;: &quot;ctx._source.tags.add(params.tag)&quot;,
        &quot;lang&quot;: &quot;painless&quot;,
        &quot;params&quot; : {
            &quot;tag&quot; : &quot;blue&quot;
        }
    }
}
结果
{
  &quot;_index&quot;: &quot;test&quot;,
  &quot;_type&quot;: &quot;type1&quot;,
  &quot;_id&quot;: &quot;1&quot;,
  &quot;_version&quot;: 3,
  &quot;found&quot;: true,
  &quot;_source&quot;: {
    &quot;counter&quot;: 5,
    &quot;tags&quot;: [
      &quot;red&quot;,
      &quot;blue&quot;
    ]
  }
}
</code></pre><p>增加新字段</p>
<pre><code>POST test/type1/1/_update
{
    &quot;script&quot; : &quot;ctx._source.new_field = \&quot;value_of_new_field\&quot;&quot;
}
</code></pre><p>删除字段</p>
<pre><code>POST test/type1/1/_update
{
    &quot;script&quot; : &quot;ctx._source.remove(\&quot;new_field\&quot;)&quot;
}
</code></pre><p>将doc参数merge到文档1中</p>
<pre><code>POST test/type1/1/_update
{
    &quot;doc&quot; : {
        &quot;name&quot; : &quot;new_name&quot;
    }
}
</code></pre><p>如果更新的文档不存在，可以插入</p>
<pre><code>POST test/type1/1/_update
{
    &quot;doc&quot; : {
        &quot;name&quot; : &quot;new_name&quot;
    },
    &quot;doc_as_upsert&quot; : true
}
</code></pre><p>mget</p>
<pre><code>GET /_mget
{
    &quot;docs&quot; : [
        {
            &quot;_index&quot; : &quot;test&quot;,
            &quot;_type&quot; : &quot;type1&quot;,
            &quot;_id&quot; : &quot;1&quot;
        },
        {
            &quot;_index&quot; : &quot;test&quot;,
            &quot;_type&quot; : &quot;type1&quot;,
            &quot;_id&quot; : &quot;2&quot;
        }
    ]
}
合并index参数
curl &apos;localhost:9200/test/_mget&apos; -d &apos;{
    &quot;docs&quot; : [
        {
            &quot;_type&quot; : &quot;type1&quot;,
            &quot;_id&quot; : &quot;1&quot;
        },
        {
            &quot;_type&quot; : &quot;type1&quot;,
            &quot;_id&quot; : &quot;2&quot;
        }
    ]
}&apos;
合并type参数
curl &apos;localhost:9200/test/type1/_mget&apos; -d &apos;{
    &quot;docs&quot; : [
        {
            &quot;_id&quot; : &quot;1&quot;
        },
        {
            &quot;_id&quot; : &quot;2&quot;
        }
    ]
}&apos;
合并id参数
curl &apos;localhost:9200/test/type/_mget&apos; -d &apos;{
    &quot;ids&quot; : [&quot;1&quot;, &quot;2&quot;]
}&apos;
</code></pre><p>当type参数为空，或者设置为_all的时候，将会返回满足id的第一条文档记录</p>
<p>mget和get类似，也可以设置_source字段的过滤</p>
<pre><code>GET /_mget
{
    &quot;docs&quot; : [
        {
            &quot;_index&quot; : &quot;test&quot;,
            &quot;_type&quot; : &quot;type1&quot;,
            &quot;_id&quot; : &quot;1&quot;,
            &quot;_source&quot; : true
        },
        {
            &quot;_index&quot; : &quot;test&quot;,
            &quot;_type&quot; : &quot;type1&quot;,
            &quot;_id&quot; : &quot;1&quot;,
            &quot;_source&quot; : [&quot;tags&quot;, &quot;counter&quot;]
        },
        {
            &quot;_index&quot; : &quot;test&quot;,
            &quot;_type&quot; : &quot;type1&quot;,
            &quot;_id&quot; : &quot;1&quot;,
            &quot;_source&quot; : {
                &quot;include&quot;: [&quot;tags&quot;],
                &quot;exclude&quot;: [&quot;name&quot;]
            }
        }
    ]
}
</code></pre><h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><h3 id="简单查询"><a href="#简单查询" class="headerlink" title="简单查询"></a>简单查询</h3><p>query_string</p>
<pre><code>GET bank/account/_search
{
  &quot;query&quot;:{
  &quot;query_string&quot;:{&quot;query&quot;:&quot;state:PA&quot;}
  }
}
</code></pre><h3 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h3><p>在上述DSL中增加</p>
<pre><code>&quot;from&quot;: 1
  , &quot;size&quot;: 3
</code></pre><h3 id="返回字段"><a href="#返回字段" class="headerlink" title="返回字段"></a>返回字段</h3><p>es5之前的版本stored_fields就叫做fields。如果未指定stored_fields，返回结果将返回_source字段。</p>
<pre><code>&quot;stored_fields&quot;:[&quot;account_number&quot;, &quot;age&quot;, &quot;state&quot;]
</code></pre><h2 id="查询DSL"><a href="#查询DSL" class="headerlink" title="查询DSL"></a>查询DSL</h2><h3 id="match-all"><a href="#match-all" class="headerlink" title="match_all"></a>match_all</h3><pre><code>GET bank/account/_search
{
  &quot;query&quot;: {
    &quot;match_all&quot;: {}
  }
}
</code></pre><h3 id="全文查询-full-text-queries"><a href="#全文查询-full-text-queries" class="headerlink" title="全文查询 full text queries"></a>全文查询 full text queries</h3><p>在查询字符串执行操作前需要分析。</p>
<h3 id="词项查询-term-level-queries"><a href="#词项查询-term-level-queries" class="headerlink" title="词项查询 term level queries"></a>词项查询 term level queries</h3><p>只针对倒排索引中的确切词（term）进行操作。经常被用在结构化数据结构，包括数字、日期、枚举等。</p>
<h4 id="词条查询"><a href="#词条查询" class="headerlink" title="词条查询"></a>词条查询</h4><p>包含改词条的文档，确切的、未经分析的词条。这里的包含，对于英文来说是空格分隔的自然词。address字段，包含avenue的。<strong><em>avenue在建立索引的时候已经变成了小写。</em></strong></p>
<pre><code>GET bank/account/_search
{
  &quot;query&quot;: {
    &quot;term&quot;: {
      &quot;address&quot;: &quot;avenue&quot;
    }
  }
}
Java API
    QueryBuilder qb = termQuery(
        &quot;address&quot;,    
        &quot;avenue&quot;   
    );
</code></pre><p>在term中可以增加boost，调节权重。在此例子中由于参与搜索的只有address一个匹配字段，所以跳转address的权重为10，相当于调整得分为原来的10倍。</p>
<pre><code>&quot;term&quot;: {
  &quot;address&quot;: {
    &quot;value&quot;: &quot;avenue&quot;,
    &quot;boost&quot;: 10
  }
}
</code></pre><h4 id="多词条查询"><a href="#多词条查询" class="headerlink" title="多词条查询"></a>多词条查询</h4><p>在5.0后，不再支持terms直接查询以及terms下的注入minimum_match等参数，需要使用filter。</p>
<pre><code>GET bank/account/_search
{
  &quot;query&quot;: {
    &quot;constant_score&quot;: {
      &quot;filter&quot;: {
        &quot;terms&quot;: {
          &quot;address&quot;: [
            &quot;avenue&quot;,
            &quot;street&quot;
          ]
        }
      }
    }
  }
}
</code></pre><h4 id="范围查询-Rang-Query"><a href="#范围查询-Rang-Query" class="headerlink" title="范围查询 Rang Query"></a>范围查询 Rang Query</h4><pre><code>GET _search
{
    &quot;query&quot;: {
        &quot;range&quot; : {
            &quot;age&quot; : {
                &quot;gte&quot; : 10,
                &quot;lte&quot; : 20,
                &quot;boost&quot; : 2.0
            }
        }
    }
}
</code></pre><p>对于日期类型可以使用Date Math</p>
<pre><code>&quot;gte&quot; : &quot;now-1d/d&quot;,
&quot;lt&quot; :  &quot;now/d&quot;
</code></pre><h4 id="存在查询-Exits-Query"><a href="#存在查询-Exits-Query" class="headerlink" title="存在查询 Exits Query"></a>存在查询 Exits Query</h4><pre><code>GET /_search
{
    &quot;query&quot;: {
        &quot;exists&quot; : { &quot;field&quot; : &quot;user&quot; }
    }
}
</code></pre><h4 id="前缀查询-Prefix-Query"><a href="#前缀查询-Prefix-Query" class="headerlink" title="前缀查询 Prefix Query"></a>前缀查询 Prefix Query</h4><pre><code>GET /_search
{ &quot;query&quot;: {
    &quot;prefix&quot; : { &quot;state&quot; : &quot;p&quot; }
  }
}
</code></pre><h4 id="通配符查询-Wildcard-Query"><a href="#通配符查询-Wildcard-Query" class="headerlink" title="通配符查询 Wildcard Query"></a>通配符查询 Wildcard Query</h4><pre><code>GET /_search
{
    &quot;query&quot;: {
        &quot;wildcard&quot; : { &quot;city&quot; : &quot;*i*ey&quot; }
    }
}
</code></pre><h4 id="正则匹配-Regexp-Query"><a href="#正则匹配-Regexp-Query" class="headerlink" title="正则匹配 Regexp Query"></a>正则匹配 Regexp Query</h4><p>详见官方文档</p>
<h4 id="模糊查询-Fuzzy-Query"><a href="#模糊查询-Fuzzy-Query" class="headerlink" title="模糊查询 Fuzzy Query"></a>模糊查询 Fuzzy Query</h4><p>将在接下来的版本中删除，使用match queries with fuzziness替代。<br>匹配方式，是使用编辑距离Levenstein distance</p>
<h4 id="类型查询-Type-Query"><a href="#类型查询-Type-Query" class="headerlink" title="类型查询 Type Query"></a>类型查询 Type Query</h4><pre><code>GET /_search
{
    &quot;query&quot;: {
        &quot;type&quot; : {
            &quot;value&quot; : &quot;account&quot;
        }
    }
}
</code></pre><h4 id="ID查询"><a href="#ID查询" class="headerlink" title="ID查询"></a>ID查询</h4><pre><code>GET /_search
{
    &quot;query&quot;: {
        &quot;ids&quot; : {
            &quot;type&quot; : &quot;account&quot;,
            &quot;values&quot; : [&quot;1&quot;, &quot;4&quot;, &quot;100&quot;]
        }
    }
}
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/image/avatar.jpg"
               alt="Sunwind" />
          <p class="site-author-name" itemprop="name">Sunwind</p>
          <p class="site-description motion-element" itemprop="description">含英咀华，凤凰于飞</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">35</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">41</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://yanan0628.github.io/" target="_blank" title="shiye">
                  
                    <i class="fa fa-globe"></i>
                  
                  shiye
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://calosfu.github.io/" target="_blank" title="dada">
                  
                    <i class="fa fa-globe"></i>
                  
                  dada
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sunwind</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"jolinzhangg"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  

</body>
</html>
